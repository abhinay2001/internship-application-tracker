- name: Run Extract/Load (Supabase -> BigQuery raw)
  env:
    SUPABASE_DB_CONN: ${{ secrets.SUPABASE_DB_CONN }}
    BQ_DATASET_RAW: raw_intern_tracker
    BQ_SA_JSON: ${{ secrets.BQ_SERVICE_ACCOUNT_JSON }}
  run: |
    # Write service account JSON EXACTLY (preserve newlines)
    printf '%s' "$BQ_SA_JSON" > /tmp/bq_sa.json

    # Use Google default auth mechanism
    export GOOGLE_APPLICATION_CREDENTIALS=/tmp/bq_sa.json

    # Sanity check (safe)
    python - << 'EOF'
    import json, os
    p = os.environ["GOOGLE_APPLICATION_CREDENTIALS"]
    with open(p) as f:
        data = json.load(f)
    print("Auth using:", data["client_email"])
    print("Has private key:", bool(data.get("private_key")))
    EOF

    python pipeline/extract_load/main.py